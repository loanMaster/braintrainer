<template>
  <div class="column items-center justify-center bg-primary q-ma-md non-selectable">
    <div class="bg-white shadow-5 rounded-borders text-center q-ma-lg q-pa-lg" style="width: 66%">
      <div class="text-h4 q-mb-sm">{{ $t('Exercise finished') }}</div>
      <div class="row justify-center text-h2 q-mb-lg" ref="stars">
        <div v-for="(val) in Array.from(Array(store.exercise.rating).keys())" :key="val" class="c-star-active animated pulse infinite" style="--animate-duration: 1s;" >â˜…</div>
        <div v-for="(val) in Array.from(Array(3 - store.exercise.rating).keys())" :key="val" class="c-star-inactive">â˜…</div>
      </div>
      <div class="row justify-center no-wrap q-mx-lg" style="min-height: 40vh">
        <div class="column flex-1">
          <div class="text-h4">Auswertung</div>
          <div class="column q-mt-lg">
            <div class="row justify-between">
              <span>GelÃ¶st</span>
              <span>{{store.exercise.correctAnswers}} / {{store.exercise.totalQuestions}}</span>
            </div>
            <div class="row justify-between">
              <span>Fehler</span>
              <span>{{ store.exercise.totalStrikeCount }}</span>
            </div>
            <div class="row justify-between">
              <span>BenÃ¶tigte Zeit</span>
              <span>{{ store.exercise.duration }} Sekunden</span>
            </div>
          </div>
          <div class="q-mt-sm">
            <div class="text-left">
              <q-skeleton type="rect" class="text-h2" v-if="!updateScoreResponse"/>
              <div v-if="updateScoreResponse" class="q-mb-sm">Besser als 64% der Spieler</div>
              <div class="text-center animated text-h6 animate bounceIn" style="--animate-duration: 2s" v-if="updateScoreResponse?.isNewHighScore">ðŸŽ‰ Neuer highscore ðŸŽ‰</div>
            </div>
          </div>
        </div>
        <div class="column flex-1">
          <div class="text-h4">Bewertung</div>
          <q-knob
            :model-value="score"
            show-value
            readonly
            size="lg"
            :thickness="0.22"
            color="lime"
            font-size="2rem"
            track-color="lime-3"
            class="text-lime q-ma-md flex-auto full-width no-pointer-events"
          />
        </div>
      </div>
      <div class="row justify-center">
        <q-btn v-if="dailyTrainingActive && hasNextDailyExercise()" @click="continueDailyTraining">{{ $t('Continue daily training') }}</q-btn>
        <q-btn @click="playAgain">{{ $t('Play again') }}</q-btn>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ScoreService, UpdateScoreResponse } from 'src/shared-services/score.service'
import { SoundService } from 'src/shared-services/sound.service'
import { DailyTrainingService } from 'src/shared-services/daily-training.service'
import { TweenService } from 'src/shared-services/tween.service'
import { NavService } from 'src/router/nav.service'
import { ref, computed, Ref, onMounted, onBeforeMount } from 'vue'
import {newExercise, useAppStore} from 'src/stores/app-store'
import {useQuasar} from "quasar";
import {useI18n} from "vue-i18n";

const store = useAppStore()
const $q = useQuasar()
const { t } = useI18n()
const stars = ref()
const scores = ref()
const score = ref(0)
const updateScoreResponse: Ref<UpdateScoreResponse | null> = ref(null)

const percentile = computed(() =>
  updateScoreResponse.value ? Math.floor(updateScoreResponse.value.percentile * 100) : 0
)

onBeforeMount(() => {
  // for debugging
  store.$patch(store => {
    store.exercise = newExercise('memory', 'hard', 10)
    store.exercise.rating = 2
    store.exercise.score = 78
  })

  if (dailyTrainingActive.value && !hasNextDailyExercise()) {
    $q.dialog({
      title: 'ðŸŽ‰ ' + t('Daily training finished')
    })
    store.finishDailyTraining() // show modal
  }
})

onMounted(async () => {
  if (store.exercise.fail) {
    new SoundService().playFail()
  } else {
    new SoundService().playLevelFinished()
  }

  if (store.player.name !== 'tester007') {
    /*updateScoreResponse.value = await new ScoreService().updateScore({ // TODO call store?
      score: score,
      nameOfTheGame: exerciseResult.nameOfTheGame,
      difficulty: exerciseResult.difficulty,
      name: $store.getters.player.name,
      id: $store.getters.player.id
    })*/
  } else {
    updateScoreResponse.value = {
      percentile: 3,
      isNewHighScore: false
    }
  }
  score.value = store.exercise.score!
  setTimeout(() => {
    updateScoreResponse.value  = {
      percentile: 3,
      isNewHighScore: true
    }
  }, 2000)
})

function playAgain () {
  new NavService().navigateTo({
    name: 'play',
    nameOfTheGame: store.exercise.nameOfTheGame.toLowerCase(),
    difficulty: store.exercise.difficulty
  })
}

const dailyTrainingActive = computed(() => store.dailyTraining.active)

function hasNextDailyExercise () {
  return new DailyTrainingService().hasNext()
}

function continueDailyTraining () {
  const { nameOfTheGame, difficulty } = new DailyTrainingService().getNextExercise()
  new NavService().navigateTo({
    name: 'play',
    nameOfTheGame: nameOfTheGame.toLowerCase(),
    difficulty
  })
}
</script>

<style scoped>
.c-star-active {
  color: yellow;
  text-shadow: 2px 1px black;
}
.c-star-inactive {
  opacity: 0.2;
  color: darkgray;
  text-shadow: 2px 1px black;
}
</style>
